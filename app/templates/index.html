<!DOCTYPE html>
<html>
<head>
    <title>Home Page</title>
    <link rel="stylesheet" href="/assets/style.css">
    <link href="/assets/bootstrap.min.css" rel="stylesheet">
    <script src="/assets/htmx.js"></script>
    <script src="/assets/bootstrap.min.js"></script>
    <link rel="stylesheet" href="/assets/flatpickr.min.css">
    <script src="/assets/flatpickr.js"></script>
    <style>
        [hx-get] {
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="container-fluid" hx-target="body" hx-push-url="true" hx-params="none">
    <div style="display: flex">
        <div class="mx-2">
            <label>Group by</label>
            {{ range .GroupByOptions }}
                <div>
                    <input type="checkbox"
                           id="group-{{ . }}"
                           {{ if $.Request.IsGroupSelected . }}checked{{ end }}
                           hx-get="{{ $.Request.LinkToggleGroup . }}"
                           class="form-check-input"
                    />
                    <label class="form-check-label"
                           for="group-{{ . }}"
                    >{{ . }}</label>
                </div>
            {{ end }}
        </div>
        <div class="mx-2">
            <label>Time Range</label>
            <fieldset style="max-width: 450px">
                <div class="input-group">
                    <button class="btn btn-primary" hx-get="{{ $.Request.LinkPrev }}">&larr;</button>
                    <input class="flatpickr form-control" id="start-date" value="{{.Request.StartValue}}"/>
                    <span class="input-group-text">To</span>
                    <input class="flatpickr form-control" id="end-date" value="{{.Request.EndValue}}"/>
                    <button class="btn btn-primary" hx-get="{{ $.Request.LinkNext }}">&rarr;</button>
                </div>
                <script>
                    function updateRange() {
                        var start = new Date(document.getElementById('start-date').value);
                        var end = new Date(document.getElementById('end-date').value);
                        let urlObject = new URL(window.location.href);
                        urlObject.searchParams.set("range", "");
                        urlObject.searchParams.set("start", start.toISOString());
                        urlObject.searchParams.set("end", end.toISOString());
                        let href = urlObject.href;
                        htmx.ajax('GET', href).then(function () {
                            history.pushState({}, '', href);
                        })
                    }

                    flatpickr("#end-date", {
                        enableTime: true,
                        dateFormat: "Y-m-d H:i",
                        time_24hr: true,
                        minDate: document.getElementById('start-date').value,
                        minuteIncrement: 60,
                        onClose: updateRange,
                    });

                    flatpickr("#start-date", {
                        enableTime: true,
                        dateFormat: "Y-m-d H:i",
                        time_24hr: true,
                        maxDate: document.getElementById('end-date').value,
                        minuteIncrement: 60,
                        onClose: updateRange
                    });
                </script>
            </fieldset>
            <div class="mt-2">
                <div class="btn-group" role="group" aria-label="Basic example">
                    {{ range .TimeRangeOptions }}
                        <input type="radio"
                               class="btn-check"
                               id="range-{{ .Value }}"
                               autocomplete="off"
                               {{ if eq .Value $.Request.Range }}checked{{ end }}
                               name="range"
                               hx-get="{{ $.Request.LinkSetRange .Value }}"
                               hx-trigger="change"
                        >
                        <label class="btn btn-primary" for="range-{{ .Value }}" class="form-label">{{.Label}}</label>
                    {{ end }}
                </div>
            </div>
        </div>
    </div>

    <table class="table table-striped table-sm mt-3 fs-6" style="line-height: 1">
        <thead>
            <tr>
                {{ range .AggData.Columns }}
                    {{$toggleOrderLink := $.Request.LinkToggleOrder .}}
                    <th {{ if ne $toggleOrderLink "" }}hx-get="{{ $toggleOrderLink }}"
                            {{ end }}>
                        {{ . }}
                        {{ if $.Request.IsOrderAsc . }}
                            <span>&#x25B2;</span>
                        {{ end }}
                        {{ if $.Request.IsOrderDesc . }}
                            <span>&#x25BC;</span>
                        {{ end }}
                    </th>
                {{ end }}
            </tr>
        </thead>
        <tbody>
        {{range .AggData.Rows}}
            <tr class="border">
                {{ range .}}
                    <td>{{.}}</td>
                {{ end }}
            </tr>
        {{end}}
        </tbody>
    </table>
    <h5>Query</h5>
    <div class="form-floating">
        <textarea
                class="form-control form-control-sm"
                id="sql-query"
                placeholder="query"
                style="height: 150px"
                readonly
        >{{ .AggData.SQLQuery }}</textarea>
        <label for="sql-query">SQL</label>
    </div>
    {{ range $index, $value := .AggData.SQLQueryArgs }}
        {{ $argIndex := add $index 1 }}
        {{ $inputID := print "sql-arg" $argIndex $}}
        <div class="form-floating my-2">
            <input
                    type="text"
                    class="form-control form-control-sm"
                    id="{{ $inputID }}"
                    placeholder="$"
                    value="{{ $value }}"
                    readonly
            >
            <label for="{{ $inputID }}">${{ $argIndex }}</label>
        </div>
    {{ end }}
</div>
</body>
</html>
