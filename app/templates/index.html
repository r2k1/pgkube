<!DOCTYPE html>
<html>
<head>
    <title>Home Page</title>
    <link rel="stylesheet" href="/assets/style.css">
    <script src="/assets/htmx.js"></script>
</head>
<body>

<h3>Group By</h3>
{{ range .GroupByOptions }}
<div>
    <input type="checkbox" id="group-{{ . }}"  {{ if $.Request.IsGroupSelected . }}checked{{ end }} hx-get="{{ $.Request.LinkToggleGroup . }}" hx-target="body" hx-push-url="true"/>
    <label for="group-{{ . }}">{{ . }}</label>
</div>
{{ end }}

<div>
    <label>Time Range</label>
    {{ range .TimeRangeOptions }}
    <div>
        <input type="checkbox" id="range-{{ .Value }}"  {{  if eq .Value $.Request.Range }}checked{{ end }} hx-get="{{ $.Request.LinkSetRange .Value }}" hx-target="body" hx-push-url="true" hx-trigger="change"/>
        <label for="range-{{ .Value }}">{{ .Label }}</label>
    </div>
    {{ end }}
    {{ if eq .Request.Range "" }}
    <label for="start-date">Start (UTC)</label>
    <input
            id="start-date"
            type="datetime-local"
            step="3600"
            value="{{ .Request.StartValue }}"
    />
    <label for="end-date">End (UTC)</label>
    <input
            id="end-date"
            type="datetime-local"
            step="3600"
            value="{{ .Request.EndValue}}"
    />
    <script>
        document.getElementById('start-date').addEventListener('change', function() {
            setDateAndReload('start', this.value)
        });

        document.getElementById('end-date').addEventListener('change', function() {
            setDateAndReload('end', this.value)
        });

        function setDateAndReload(param, value) {
            var selectedDateTime = value + ':00Z';
            var newUrl = updateUrlParameter(window.location.href, param, selectedDateTime);
            console.log(this.value, selectedDateTime, newUrl);
            htmx.ajax('GET', newUrl).then(function () {
                history.pushState({}, '', newUrl);
            })
        }

        function updateUrlParameter(url, paramName, paramValue) {
            let urlObject = new URL(url);
            urlObject.searchParams.set(paramName, paramValue);
            return urlObject.href;
        }
    </script>
    {{ end }}

</div>

<table>
    <thead>
        <tr>
            {{ range .AggData.Columns }}
                {{$toggleOrderLink := $.Request.LinkToggleOrder .}}
                    <th {{ if ne $toggleOrderLink "" }}hx-get="{{ $toggleOrderLink }}" hx-target="body" hx-push-url="true"{{ end }}>
                        {{ . }}
                        {{ if $.Request.IsOrderAsc . }}
                            <span>&#x25B2;</span>
                        {{ end }}
                        {{ if $.Request.IsOrderDesc . }}
                            <span>&#x25BC;</span>
                        {{ end }}
                    </th>
            {{ end }}
        </tr>
    </thead>
    <tbody>
        {{range .AggData.Rows}}
        <tr>
            {{ range .}}
                <td>{{.}}</td>
            {{ end }}
        </tr>
        {{end}}
    </tbody>
</table>
<h3>SQL Query</h3>
<textarea rows="10" cols="140">
{{ .AggData.SQLQuery }}

{{ range .AggData.SQLQueryArgs }}{{ . }}{{ end }}
</textarea>

</body>
</html>
